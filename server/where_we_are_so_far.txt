================================================================================
FALL DETECTION ALGORITHM - SESSION SUMMARY
Date: December 13, 2025
================================================================================

OBJECTIVE:
----------
Modify the motorcycle fall detection algorithm to detect low-speed tip-overs 
(1.45g threshold) in addition to high-speed crashes. The original algorithm 
required a three-phase sequence (deceleration → freefall → impact) which 
doesn't occur in gentle falls.


WHAT WE ACHIEVED:
-----------------

1. LOWERED IMPACT THRESHOLD
   - Changed from 25.0 m/s² (2.55g) to 14.22 m/s² (1.45g)
   - File: server/src/fall-detection/constants.js
   - Line 35: IMPACT_THRESHOLD: 14.22

2. IMPLEMENTED DUAL-MODE DETECTION
   - Mode 1: Three-phase detection (original, strict)
     * Requires: deceleration → freefall → impact sequence
     * For high-speed crashes
   
   - Mode 2: Impact-only detection (new, relaxed)
     * Requires: impact >1.45g + post-impact stillness
     * For low-speed tip-overs
     * Added function: detectPostImpactStillness()
   
   - File: server/src/fall-detection/index.js
   - Lines 254-290: detectPostImpactStillness() function
   - Lines 370-395: Relaxed mode logic

3. ADDED POST-IMPACT STILLNESS CHECK
   - After detecting impact >1.45g, checks for motorcycle at rest
   - Allows 2 seconds for sliding/tumbling after impact
   - Then checks for 1.5 seconds of stillness (~1g, low variance)
   - This filters out false positives (rough roads, aggressive maneuvers)
   
   Parameters (lines 255-259):
   - SLIDING_WINDOW = 2.0s (allow time for sliding)
   - STILLNESS_WINDOW = 1.5s (check period)
   - STILLNESS_THRESHOLD = 12.0 m/s² (~1.22g)
   - STILLNESS_VARIANCE_THRESHOLD = 3.0

4. OPTIMIZED TEST SUITE WITH CHUNK FILTERING
   - Pre-filters chunks that don't contain impacts >14.22 m/s²
   - Reduced tests from 957 to 715 (242 chunks filtered)
   - Only 11 relevant fall chunks remain (down from 254)
   - File: server/scripts/run_normalized_tests.js
   - Lines 33-47: getChunkPeakAcceleration() function
   - Lines 53-82: chunkFileIfNeeded() with filtering

5. FIXED CRASH BUG
   - Original code crashed when accessing validFalls[0] with empty array
   - Fixed by adding validFalls.length > 0 check
   - File: server/src/fall-detection/index.js
   - Line 418: summary condition now checks array length

6. ADDED NPM TEST SCRIPT
   - File: server/package.json
   - Added: "test:normalized": "node scripts/run_normalized_tests.js"
   - Run with: npm run test:normalized


CURRENT CODE STRUCTURE:
------------------------

server/
├── src/fall-detection/
│   ├── index.js                   # Main detection algorithm
│   │   ├── detectDecelerationPhase()    (Phase 1)
│   │   ├── detectFreefallPhase()        (Phase 2)
│   │   ├── detectImpactPhase(strictMode) (Phase 3)
│   │   ├── validateFallSequence()       (Three-phase validation)
│   │   ├── detectPostImpactStillness()  (NEW: Stillness check)
│   │   └── detectFall()                  (Main entry point)
│   │
│   ├── constants.js               # Threshold configuration
│   │   └── IMPACT_THRESHOLD: 14.22 m/s²
│   │
│   └── router.js                  # Express endpoints
│       └── POST /receive-data → detectFall()
│
├── scripts/
│   └── run_normalized_tests.js   # Test suite with filtering
│       ├── getChunkPeakAcceleration() (NEW: Pre-scan chunks)
│       └── chunkFileIfNeeded()         (Modified: Filter chunks)
│
└── test-cases/
    └── normalized_chunks/         # Generated from normalized datasets
        ├── fall/                  # 11 chunks with peaks >14.22 m/s²
        └── no_fall/               # 704 chunks (various scenarios)


NORMALIZED FILES vs ORIGINAL FILES:
------------------------------------

ORIGINAL FILES (NormalizedDatasets/):
- Raw sensor data from actual motorcycle rides
- Full-length recordings (e.g., "Fall in a curve" = ~46,000 rows)
- Tab-separated format
- Columns: Time, Accel X, Accel Y, Accel Z, Absolute Accel

NORMALIZED CHUNKS (test-cases/normalized_chunks/):
- Generated by run_normalized_tests.js during test execution
- Split into 1200-line chunks for HTTP testing
- Same format as originals
- Stored in: test-cases/normalized_chunks/<fall|no_fall>/<scenario>/
- Example: Fall in a curve → 8 chunks (chunk-001 through chunk-008)

IMPORTANT: The test suite creates chunks ON THE FLY from original files.
These chunks are temporary and stored in normalized_chunks/ directory.


THE PROBLEM WE'RE FIXING:
--------------------------

ISSUE: Algorithm detects falls but returns fallDetected=false

TEST RESULTS (as of last run):
- Total: 715 tests
- Passed: 703 (all no_fall scenarios ✓)
- Failed: 11 (all fall scenarios ✗)

WHAT'S WORKING:
✓ Three-phase detection (but fall scenarios don't have three-phase sequence)
✓ Relaxed mode detects impacts >14.22 m/s²
✓ No false positives (rough roads correctly rejected)
✓ Chunk filtering works (keeps only relevant chunks)

WHAT'S NOT WORKING:
✗ Actual falls are not detected (11 fall chunks fail)
✗ Possible reason: Post-impact stillness check is too strict OR data ends 
  before stillness period

HYPOTHESIS - MISSING CHUNKS:
The fall datasets were chunked into 1200-line segments. If the impact occurs
near the END of a chunk, there may not be enough data AFTER the impact to
observe the stillness period (needs 2s sliding + 1.5s stillness = 3.5s).

Example:
- Chunk has 1200 lines ≈ 12 seconds of data (100Hz sampling)
- Impact at t=10s
- Stillness check starts at t=12s (10s + 2s sliding)
- But chunk ends at t=12s!
- Result: stillnessPoints.length < 10 → fails check

VERIFICATION NEEDED:
1. Check if impacts occur near end of chunks
2. Check if chunk boundaries cut off post-impact data
3. Consider using ORIGINAL full-length files instead of chunks
4. Or modify test suite to test full files, not chunks


SERVER LOGS TO CHECK:
----------------------

When running a test, the server console shows:

Phase 1: Detected X deceleration events
Phase 2: Detected X freefall events
Phase 3: Detected X impact events (strict mode)
Validated X three-phase falls
  No three-phase fall detected, trying relaxed mode...
  Relaxed mode: Detected X impact events
  Checking X impacts for post-impact stillness...
  Checking impact at Ts with peak X m/s²
    Stillness check: Not enough data (X points after Ts)  ← KEY MESSAGE
    Stillness check at Ts: avg=X m/s², variance=X, still=false/true
  Impacts with post-impact stillness: X
  ✓/✗ Simplified detection: ...

EXPECTED for fall chunks:
- Relaxed mode: Detected >0 impact events
- If "Not enough data" appears → chunks end too early
- If "still=false" appears → stillness parameters too strict


NEXT STEPS:
-----------

1. RUN DEBUG TEST:
   node debug_one_test.js
   
   Look for console output showing:
   - "Relaxed mode: Detected X impact events" (should be >0)
   - "Checking X impacts for post-impact stillness..."
   - Stillness check results for each impact

2. IF "Not enough data" appears frequently:
   → Test with full original files instead of chunks
   → Modify test suite to use NormalizedDatasets/ directly
   → Or ensure chunks overlap so post-impact data is captured

3. IF stillness checks run but all fail (still=false):
   → Check actual avg acceleration values in failed cases
   → May need to relax STILLNESS_THRESHOLD or STILLNESS_VARIANCE_THRESHOLD
   → Or reduce STILLNESS_WINDOW if motorcycle isn't perfectly still

4. TO TEST FULL FILES:
   Create a test that loads full original datasets:
   - NormalizedDatasets/fall/Fall in a curve/Fall in a curve.csv
   - NormalizedDatasets/fall/Fall in the roundabout/Fall in the roundabout.csv
   - etc.
   
   This will have complete post-impact data without chunk boundaries.


FILES MODIFIED IN THIS SESSION:
--------------------------------

1. server/src/fall-detection/constants.js
   - Line 35: IMPACT_THRESHOLD changed to 14.22

2. server/src/fall-detection/index.js
   - Lines 221-250: Modified detectImpactPhase() to accept strictMode parameter
   - Lines 254-290: Added detectPostImpactStillness() function
   - Lines 370-395: Added relaxed mode detection logic
   - Line 418: Fixed crash by checking validFalls.length > 0
   - Lines 421-445: Modified Discord notification to handle both detection modes

3. server/scripts/run_normalized_tests.js
   - Line 9: Added IMPACT_THRESHOLD constant
   - Lines 33-47: Added getChunkPeakAcceleration() function
   - Lines 53-82: Modified chunkFileIfNeeded() to filter chunks
   - Lines 108-109: Pass expectFall parameter to chunkFileIfNeeded()

4. server/package.json
   - Line 12: Added "test:normalized" script

5. server/debug_one_test.js (NEW)
   - Created for debugging single test cases


HOW TO RUN:
-----------

1. Start server:
   cd server
   npm start

2. Run tests:
   npm run test:normalized

3. Debug single test:
   node debug_one_test.js

4. Test via API:
   $csvData = Get-Content "test-cases/normalized_chunks/fall/Fall in a curve/Fall in a curve-chunk-001.csv" -Raw
   Invoke-RestMethod -Uri "http://localhost:3030/fall-detection/receive-data" -Method POST -Body $csvData -ContentType "text/csv"


DATA ANALYSIS FINDINGS:
-----------------------

Fall scenario peak accelerations:
- Fall in a curve: 1.57g (peak in chunk-001: 14.567 m/s²)
- Fall in the roundabout: 1.86g
- Fall on slippery: 1.20g (below 1.45g threshold - will never detect)
- Fall with leaning: 1.88g

No-fall scenario peak accelerations (examples):
- Rough roads: 1.63g (overlaps with falls!)
- Harsh braking: ~1.5-1.6g
- Aggressive turns: ~1.4-1.6g

This is why post-impact stillness check is CRITICAL - can't distinguish 
falls from rough roads by acceleration alone.


CONTACT INFO FOR HANDOFF:
--------------------------

The algorithm architecture is sound. The issue is likely:
1. Chunks ending before stillness can be observed, OR
2. Stillness parameters need tuning based on actual fall data

Check the server console logs to diagnose which issue is occurring.

================================================================================
END OF SESSION SUMMARY
================================================================================

================================================================================
UPDATE: December 13, 2025 - Testing Results with Full Files
================================================================================

CONFIRMED: The chunking hypothesis was correct!

TEST RESULTS - CHUNKED FILES (run_normalized_tests.js):
- Total: 715 chunks
- Passed: 703
- Failed: 12 (all fall scenarios)
- Issue: Chunks end before post-impact stillness can be observed

TEST RESULTS - FULL FILES (run_full_file_tests.js):  
- Total: 11 files
- Passed: 3
- Failed: 8

BREAKDOWN:
✓ Fall scenarios (3/4 passing):
  - ✓ Fall in a curve
  - ✓ Fall in the roundabout  
  - ✗ Fall on slippery (peak 1.20g < 1.45g threshold - expected failure)
  - ✓ Fall with leaning

✗ No-fall scenarios (0/7 passing - ALL FALSE POSITIVES!):
  - ✗ Acceleration On Curve
  - ✗ Acceleration On Straight Line
  - ✗ Fall Like manoeuvre 1, 2, 3
  - ✗ Harsh breaking On Straight Line
  - ✗ Much degraded track

ROOT CAUSE IDENTIFIED:
The post-impact stillness check is TOO LENIENT. It cannot distinguish between:
1. Real fall stillness (device lying on ground after crash)
2. Normal stop stillness (motorcycle at traffic light, red light, etc.)

Both scenarios have:
- Impacts > 1.45g (rough roads ~1.6g, harsh braking ~1.5g)
- Periods of stillness (avg ~12 m/s², low variance)

CURRENT STILLNESS PARAMETERS (index.js:261-264):
  STILLNESS_THRESHOLD = 12.0 m/s² (~1.22g)
  STILLNESS_VARIANCE_THRESHOLD = 3.0
  STILLNESS_WINDOW = 1.5 seconds
  SLIDING_WINDOW = 2.0 seconds

PROPOSED SOLUTIONS:

Option 1: TIGHTEN STILLNESS THRESHOLDS
- Lower STILLNESS_THRESHOLD to 8.0 m/s² (~0.8g)
  * Real fall: device at odd angle, accel < 0.8g
  * Traffic stop: upright bike, accel ~1.0g vertical
- Lower VARIANCE_THRESHOLD to 1.0
  * Requires more consistent stillness

Option 2: ADD ORIENTATION CHECK
- After impact, check if device orientation changed significantly
- Real fall: orientation changes (upright → sideways)
- Traffic stop: orientation stays upright
- Requires gyroscope data analysis

Option 3: COMBINE BOTH
- Use stricter thresholds AND orientation check
- Most robust solution

NEXT STEPS:
1. Try Option 1 first (easiest to test)
2. Run full-file tests to verify
3. If still false positives, add Option 2

================================================================================
